############################
#
# Gray Goo Events
#
# Written by Henrik Thyrwall
#
############################

namespace = graygoo
# Encountered Gray
ship_event = {
	id = graygoo.400
	title = "graygoo.400.name"

	trigger = {
		NOT = {
			any_playable_country = {
				has_country_flag = gray_owner
			}
		}
	}
	
	desc = {
		trigger = {
			owner = { is_synthetic_empire = no }
		}
		text = "graygoo.400.a.desc"
	}
	desc = {
		trigger = { 
			owner = { is_synthetic_empire = yes } 
		}
		text = "graygoo.400.b.desc"
	}
	picture = GFX_evt_ship_in_orbit_2
	show_sound = event_radio_chatter

	is_triggered_only = yes

	immediate = {
		from = { save_event_target_as = gray_homeworld }
	}

	option = {
		name = graygoo.400.a
		hidden_effect = {
			owner = {
				country_event = { id = graygoo.401 }
			}
		}
	}
}

# Gray 1
country_event = {
	id = graygoo.401
	title = "TRANSMISSION"
	desc = {
		trigger = { NOT = { has_authority = auth_machine_intelligence } }
		text = "graygoo.401.a.desc"
	}
	desc = {
		trigger = { has_authority = auth_machine_intelligence }
		text = "graygoo.401.b.desc"
	}

	is_triggered_only = yes
	
	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gray_species
		planet_background = event_target:gray_homeworld
		room = "ethic_spaceship_room"
	}

	immediate = {
		hidden_effect = {
			rg_create_gray_species = yes
		}
	}

	option = {
		name = graygoo.401.a
		trigger = {
			NOR = {
				has_authority = auth_machine_intelligence
				has_authority = auth_hive_mind
			}
		}
		hidden_effect = {
			country_event = { id = graygoo.402 }
		}
	}
	option = {
		name = graygoo.401.b
		trigger = {
			has_authority = auth_machine_intelligence
		}
		hidden_effect = {
			country_event = { id = graygoo.402 }
		}
	}
	option = {
		name = graygoo.401.c
		trigger = {
			has_authority = auth_hive_mind
		}
		hidden_effect = {
			country_event = { id = graygoo.402 }
		}
	}
	
}

# Gray 2
country_event = {
	id = graygoo.402
	title = "TRANSMISSION"
	desc = {
		trigger = { NOT = { has_authority = auth_machine_intelligence } }
		text = "graygoo.402.a.desc"
	}
	desc = {
		trigger = { has_authority = auth_machine_intelligence }
		text = "graygoo.402.b.desc"
	}

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gray_species
		planet_background = event_target:gray_homeworld
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.402.a
		hidden_effect = {
			country_event = { id = graygoo.403 }
		}
	}
}

# Gray 3
country_event = {
	id = graygoo.403
	title = "TRANSMISSION"
	desc = "graygoo.403.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gray_species
		planet_background = event_target:gray_homeworld
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.403.a
		hidden_effect = {
			country_event = { id = graygoo.404 }
		}
	}
}

# Gray 4
country_event = {
	id = graygoo.404
	title = "TRANSMISSION"
	desc = "graygoo.404.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gray_species
		planet_background = event_target:gray_homeworld
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.404.a
		hidden_effect = {
			country_event = { id = graygoo.405 }
		}
	}
}

# Gray 5
country_event = {
	id = graygoo.405
	title = "TRANSMISSION"
	desc = "graygoo.405.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gray_species
		planet_background = event_target:gray_homeworld
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.405.a
		hidden_effect = {
			rg_gray_govener_init = yes
			owner = {
				country_event = { id = graygoo.406 }
			}
		}
	}
	option = {
		name = graygoo.405.b
		response_text = graygoo.405.b.response
		hidden_effect = {
			event_target:gray_governor = {
				kill_leader = { show_notification = no }
			}
		}
	}
}

# Gray 6
country_event = {
	id = graygoo.406
	title = "TRANSMISSION"
	desc = "graygoo.406.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gray_governor
		planet_background = event_target:gray_homeworld
		room = ship_room
	}

	event_window_type = leader_recruit
	is_triggered_only = yes

	option = {
		name = graygoo.406.a
		response_text = graygoo.406.a.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.406.b
		response_text = graygoo.406.b.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.405.b
		tag = dismiss_leader
		response_text = graygoo.405.b.response
		hidden_effect = {
			event_target:gray_governor = {
				kill_leader = { show_notification = no }
			}
		}
	}
	option = {
		name = graygoo.406.c
		response_text = graygoo.406.c.response
		default_hide_option = yes
		tag = hire_leader
		hidden_effect = {
			country_event = { id = graygoo.499 }
		}
	}
}

# Create Gray
country_event = {
	id = graygoo.499
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		NOT = { exists = event_target:gray_owner }
		is_ai = no
	}

	immediate = {
		create_country = {
			name = "NAME_Gray"
			type = gray
			flag = {
				icon= {
					category = "special"
					file = "gray_goo.dds"
				}
				background= {
					category = "backgrounds"
					file = "sinus.dds"
				}
				colors={
					"grey"
					"dark_grey"
					"null"
					"null"
				}
			}
			effect = {
				rg_create_gray_species = yes
				# 灰风国家用于领袖切换时暂存领袖
				set_country_flag = can_have_wg_affection_country_flag
			}
		}
		last_created_country = {
			establish_communications_no_message = root
			save_global_event_target_as = rg_gray_country
		}
		# 送灰风母舰初始科技
		give_technology = {
			tech = tech_object_gray_5
			message = no 
		}
		save_global_event_target_as = gray_owner
		set_country_flag = gray_owner
		#初始化好感度和衣柜
		set_variable = { which = gray_affection value = 1 }
		set_variable = { which = gray_affection_level value = 1 }
		set_variable = { which = wg_gray_cloth value = 6 }

		# 否则事件会自动移除好感度特质(回娘家时保留特质）
		set_country_flag = can_have_wg_affection_country_flag
		# 默认关闭自动建造中继器
		# set_country_flag = rg_can_const_hyper_relay
		# 初始化小灰领袖等级
		if = {
			limit = { 
				OR = {
					has_country_flag = origin_rg_gray #遥远约定
					has_country_flag = origin_gray_country #远星之歌
				}
			}
			set_variable = { which = rg_gray_level value = 1 }
		} else = {
			set_variable = { which = rg_gray_level value = 10 }
		}
		rg_storyline_trigger = yes
	}
}

# Main Menu (Initial)
country_event = {
	id = graygoo.500
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOR = {
			has_global_flag = has_wsg_mod
			has_global_flag = kdc_event_mod_active
		}
		from = { OR = {
			is_country_type = gray 
			is_same_value = ROOT
		}}
		is_same_value = event_target:gray_owner
		NOR = {
			has_country_flag = gray_constship_active
			has_country_flag = gray_governor_active
			has_country_flag = gray_warship_active
			has_country_flag = gray_army_active
			has_country_flag = gray_reforming
			has_country_flag = gray_diplomacy_engaged
		}
	}

	immediate = {
		if = { # 检查是否存在任何形式的小灰
			limit = {
				any_owned_leader = {
					NOR = {
						has_leader_flag = rg_gray_leader
						OR = {
							has_leader_flag = gray_governor
							has_leader_flag = gray_admiral
							has_leader_flag = gray_general
							has_leader_flag = gray_scientist
						}
					}
				}
			}
			rg_gray_govener_init = yes #创建一个衣架子
		}
		country_event = { id = rg_grayleader.500 } #放行。
	}
}

# Main Menu (Governor)
country_event = {
	id = graygoo.501
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOR = {
			has_global_flag = has_wsg_mod
			has_global_flag = kdc_event_mod_active
		}
		from = { OR = {
			is_country_type = gray 
			is_same_value = ROOT
		}}
		is_same_value = event_target:gray_owner
		has_country_flag = gray_governor_active
		NOR = { 
			has_country_flag = gray_reforming 
			has_country_flag = gray_diplomacy_engaged
		}
		exists = event_target:gray_governor
	}

	immediate = {
		if = { # 检查是否存在任何形式的小灰
			limit = {
				any_owned_leader = {
					NOR = {
						has_leader_flag = rg_gray_leader
						OR = {
							has_leader_flag = gray_governor
							has_leader_flag = gray_admiral
							has_leader_flag = gray_general
							has_leader_flag = gray_scientist
						}
					}
				}
			}
			rg_gray_govener_init = yes #创建一个衣架子
		}
		country_event = { id = rg_grayleader.501 } #放行。
	}
}

# Main Menu (Warship)
country_event = {
	id = graygoo.502
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOR = {
			has_global_flag = has_wsg_mod
			has_global_flag = kdc_event_mod_active
		}
		from = { OR = {
			is_country_type = gray 
			is_same_value = ROOT
		}}
		is_same_value = event_target:gray_owner
		has_country_flag = gray_warship_active
		NOR = { 
			has_country_flag = gray_reforming 
			has_country_flag = gray_diplomacy_engaged
		}
		exists = event_target:gray_warship
		any_owned_fleet = { is_same_value = event_target:gray_warship }
		event_target:gray_warship = { num_ships > 0 }
	}

	immediate = {
		if = { # 检查是否存在任何形式的小灰
			limit = {
				any_owned_leader = {
					NOR = {
						has_leader_flag = rg_gray_leader
						OR = {
							has_leader_flag = gray_governor
							has_leader_flag = gray_admiral
							has_leader_flag = gray_general
							has_leader_flag = gray_scientist
						}
					}
				}
			}
			rg_gray_admiral_init = yes #创建一个衣架子
		}
		country_event = { id = rg_grayleader.502 } #放行。
	}
}

# Main Menu (Army)
country_event = {
	id = graygoo.503
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOR = {
			has_global_flag = has_wsg_mod
			has_global_flag = kdc_event_mod_active
		}
		from = { OR = {
			is_country_type = gray 
			is_same_value = ROOT
		}}
		has_country_flag = gray_army_active
		NOR = { 
			has_country_flag = gray_reforming 
			has_country_flag = gray_diplomacy_engaged 

		}
		is_same_value = event_target:gray_owner
		any_owned_army = {
			army_type = gray_army
			OR = {
				exists = planet
				AND = {
					exists = fleet
					fleet = { num_ships > 0 }
				}
			}
		}
	}

	immediate = {
		if = { # 检查是否存在任何形式的小灰
			limit = {
				any_owned_leader = {
					NOR = {
						has_leader_flag = rg_gray_leader
						OR = {
							has_leader_flag = gray_governor
							has_leader_flag = gray_admiral
							has_leader_flag = gray_general
							has_leader_flag = gray_scientist
						}
					}
				}
			}
			rg_gray_general_init = yes #创建一个衣架子
		}
		country_event = { id = rg_grayleader.503 } #放行。
	}
}

# Main Menu (Gray Reforming)
country_event = {
	id = graygoo.504
	title = "graygoo.500.title"
	desc = "graygoo.504.desc"

	diplomatic = yes

	is_triggered_only = yes

	trigger = {
		NOR = {
			has_global_flag = has_wsg_mod
			has_global_flag = kdc_event_mod_active
		}
		from = { OR = {
			is_country_type = gray 
			is_same_value = ROOT
		}}
		is_same_value = event_target:gray_owner
		has_country_flag = gray_reforming
	}

	option = {
		name = OK
	}

	option = {
		name = rg_graygoo.504.a
		allow = {
			has_country_flag = gray_reforming
			resource_stockpile_compare = { resource = nanites value >= 1000 }
			resource_stockpile_compare = { resource = alloys value >= 50000 }
		}
		add_resource = {
			nanites = -1000
			alloys = -50000
		}
		remove_country_flag = gray_reforming
		remove_modifier = "gray_scattered"
	}
}

# Main Menu (const)
country_event = {
	id = graygoo.505
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOR = {
			has_global_flag = has_wsg_mod
			has_global_flag = kdc_event_mod_active
		}
		from = { OR = {
			is_country_type = gray 
			is_same_value = ROOT
		}}
		is_same_value = event_target:gray_owner
		has_country_flag = gray_constship_active
		NOR = { 
			has_country_flag = gray_reforming 
			has_country_flag = gray_diplomacy_engaged

		}
		exists = event_target:global_gray_constship
		any_owned_fleet = { is_same_value = event_target:global_gray_constship }
		event_target:global_gray_constship = { num_ships > 0 }
	}

	immediate = {
		if = { # 检查是否存在任何形式的小灰
			limit = {
				any_owned_leader = {
					NOR = {
						has_leader_flag = rg_gray_leader
						OR = {
							has_leader_flag = gray_governor
							has_leader_flag = gray_admiral
							has_leader_flag = gray_general
							has_leader_flag = gray_scientist
						}
					}
				}
			}
			rg_gray_scientist_init = yes #创建一个衣架子
		}
		country_event = { id = rg_grayleader.505 } #放行。
	}
}

# Gray destroyed or disbanded
event = {
	id = graygoo.510
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		any_country = { is_country_type = gray }
		exists = event_target:gray_owner
		event_target:gray_owner = {
			OR = {
				AND = {
					has_country_flag = gray_army_active
					NOT = {
						any_owned_army = { army_type = gray_army }
					}
				}
				AND = {
					has_country_flag = gray_warship_active
					NOT = { exists = event_target:gray_warship }
				}
				AND = {
					has_country_flag = gray_governor_active
					NOT = { exists = event_target:gray_governor }
				}
				AND = {
					has_country_flag = gray_constship_active
					NOT = { exists = event_target:global_gray_constship }
				}
			}
		}
	}

	immediate = {
		event_target:gray_owner = {
			remove_country_flag = gray_governor_active #总督
			remove_country_flag = gray_warship_active #旗舰
			remove_country_flag = gray_army_active #陆军
			remove_country_flag = gray_constship_active #科舰
			set_country_flag = gray_reforming
			add_modifier = {
				modifier = "gray_scattered"
				days = 3600
			}
			country_event = { id = graygoo.511 }
			country_event = { id = graygoo.512 days = 3600 }
		}
	}
}

# Gray regenerating
country_event = {
	id = graygoo.511
	title = "graygoo.511.name"
	desc = "graygoo.511.desc"
	picture = GFX_evt_circuitry_modification
	show_sound = event_radio_chatter

	is_triggered_only = yes

	option = {
		name = graygoo.511.a
	}
}

# Gray Returns
country_event = {
	id = graygoo.512
	title = "graygoo.500.title"
	desc = "graygoo.512.a.desc"
	desc = "graygoo.512.b.desc"
	desc = "graygoo.512.c.desc"

	diplomatic = yes


	is_triggered_only = yes
	

	immediate = {
		remove_country_flag = gray_reforming
	}

	option = {
		name = graygoo.512.a
	}
}
